<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR View</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    a-scene {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
  <!-- 1. A-Frame 1.3.0 -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- 2. AR.js 3.4.5 (специальная сборка для A-Frame) -->
  <script src="https://www.unpkg.com/@ar-js-org/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <!-- 3. A-Frame Extras -->
  <script src="https://cdn.jsdelivr.net"></script>
</head>

<body>
  <a-scene embedded arjs="sourceType: webcam; patternRatio: 0.75; debugUIEnabled: false;" vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;">
    <a-assets>
      <a-asset-item id="model" src=""></a-asset-item>
    </a-assets>
    <a-marker type="pattern" url="" smooth="true" smoothCount="10" smoothTolerance="0.01">
      <a-entity id="ar-model" gltf-model="#model" scale="0.5 0.5 0.5" animation-mixer="clip: *"></a-entity>
    </a-marker>
    <a-camera id="ar-camera" position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>
  </a-scene>
  <script>
    // window.addEventListener('load', function () {
    //   // Попытка запросить камеру через mediaDevices (для отладки)
    //   if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    //     navigator.mediaDevices.getUserMedia({ video: true })
    //       .then(function (stream) {
    //         // Останавливаем поток, так как AR.js сам его возьмёт
    //         stream.getTracks().forEach(track => track.stop());
    //       })
    //       .catch(function (err) {
    //         alert('Для работы AR необходимо разрешить доступ к камере');
    //       });
    //   }
    // });

    (function () {
      const params = new URLSearchParams(window.location.search);
      const modelUrl = params.get('model');
      const markerUrl = params.get('marker');
      const apiBase = params.get('apiBase') || '';

      if (modelUrl) {
        document.querySelector('#model').setAttribute('src', apiBase + modelUrl);
      }
      if (markerUrl) {
        document.querySelector('a-marker').setAttribute('url', apiBase + markerUrl);
      }

      // Слушаем сообщения от родителя
      window.addEventListener('message', (event) => {
        if (event.data.type === 'setScale') {
          const scale = event.data.scale;
          const modelEntity = document.querySelector('#ar-model');
          if (modelEntity) {
            modelEntity.setAttribute('scale', `${scale} ${scale} ${scale}`);
          }
        }
      });

      // Адаптация камеры при изменении размера окна iframe
      const sceneEl = document.querySelector('a-scene');
      const resizeObserver = new ResizeObserver(() => {
        if (sceneEl && sceneEl.camera) {
          const width = window.innerWidth;
          const height = window.innerHeight;
          sceneEl.camera.aspect = width / height;
          sceneEl.camera.updateProjectionMatrix();
        }
      });
      resizeObserver.observe(document.body);

      // Первоначальная установка аспекта
      setTimeout(() => {
        if (sceneEl && sceneEl.camera) {
          sceneEl.camera.aspect = window.innerWidth / window.innerHeight;
          sceneEl.camera.updateProjectionMatrix();
        }
      }, 200);
    })();
  </script>
</body>

</html>